

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>理解Linux启动 &mdash; Ubuntu GNU/linux 笔记 v0.1 documentation</title>
    <link rel="stylesheet" href="../b_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../b_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../b_static/jquery.js"></script>
    <script type="text/javascript" src="../b_static/underscore.js"></script>
    <script type="text/javascript" src="../b_static/doctools.js"></script>
    <script type="text/javascript" src="../b_static/sidebar.js"></script>
    <link rel="top" title="Ubuntu GNU/linux 笔记 v0.1 documentation" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">Ubuntu GNU/linux 笔记 v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="linux">
<h1>理解Linux启动<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h1>
<ol class="arabic">
<li><p class="first">系统启动（BIOS）</p>
</li>
<li><dl class="first docutils">
<dt>引导程序 （Bootloader）</dt>
<dd><ol class="first last arabic simple">
<li>stage 1 (MBR)</li>
<li>stage 2</li>
</ol>
</dd>
</dl>
</li>
<li><p class="first">内核启动 （Kernel）</p>
</li>
<li><p class="first">启动控制 (Init)</p>
</li>
<li><p class="first">登录管理 (LightDM)</p>
</li>
<li><p class="first">交互环境 (/etc/profile)</p>
</li>
</ol>
<div class="section" id="bios">
<h2>系统启动（BIOS）<a class="headerlink" href="#bios" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="glossary.html#term-cmos"><em class="xref std std-term">CMOS</em></a> 是一个可读写的RAM，记录一些配置信息， 比如从硬盘启动。</p>
<p><a class="reference internal" href="glossary.html#term-bios"><em class="xref std std-term">BIOS</em></a> 是一个程序，开机 <a class="reference internal" href="glossary.html#term-post"><em class="xref std std-term">POST</em></a> 后，根据 <a class="reference internal" href="glossary.html#term-cmos"><em class="xref std std-term">CMOS</em></a> 的设置搜索处于活动状态的可引导设备。</p>
<p>然后 <strong>BIOS交权给MBR</strong></p>
</div>
<div class="section" id="bootloader">
<h2>引导程序 （Bootloader）<a class="headerlink" href="#bootloader" title="Permalink to this headline">¶</a></h2>
<p>Bootloader有许多种，这里讲Ubuntu实际应用的GRUB2。</p>
<p>GRUB2有个命令：grub-install，install GRUB to a device。这个命令的帮助里有这句话</p>
<div class="highlight-python"><pre>grub-install copies GRUB images into /boot/grub, and uses grub-setup to install grub into the boot sector.</pre>
</div>
<p>所以平常说的stage1(MBR)和stage2只是一个程序分开放在两处。BIOS引导MBR，MBR引导GRUB2，GRUB2引导Kernel。</p>
<div class="section" id="stage-1">
<h3>Stage 1<a class="headerlink" href="#stage-1" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="glossary.html#term-mbr"><em class="xref std std-term">MBR</em></a> 位于硬盘第一个扇区。由三部分组成引导程序、分区表、特殊结束字节</p>
<p>前446字节的引导程序会直接去引导stage2</p>
<ul class="simple">
<li>MBR的结构</li>
</ul>
<img alt="../b_images/mbr.gif" src="../b_images/mbr.gif" />
<div class="highlight-python"><pre>512 = 446 + (4 X 16) + 2</pre>
</div>
<ul class="simple">
<li>通过命令，读取显示MBR里的 <strong>分区表和结束标志位</strong> ，具体观察下。</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">sudo</span> <span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span> <span class="n">of</span><span class="o">=</span><span class="n">mbr</span><span class="o">.</span><span class="n">bin</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span> <span class="n">skip</span><span class="o">=</span><span class="mi">446</span> <span class="n">count</span><span class="o">=</span><span class="mi">66</span>
<span class="go">记录了66+0 的读入</span>
<span class="go">记录了66+0 的写出</span>
<span class="go">66字节(66 B)已复制，0.000403999 秒，163 kB/秒</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xxd</span> <span class="n">mbr</span><span class="o">.</span><span class="n">bin</span>
<span class="go">0000000: 8001 0100 0cfe ffff 3f00 0000 72a1 a903  ........?...r...</span>
<span class="go">0000010: 0000 feff 0f35 f4ff eea1 a903 12f6 f70e  .....5..........</span>
<span class="go">0000020: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span>
<span class="go">0000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span>
<span class="go">0000040: 55aa</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>为什么只用4个分区表记录? 够不够用？</p>
<p>因为就是这样，只能有四个分区表记录，对应四个主/扩展分区。</p>
<p class="last">不过扩展分区可以划逻辑分区。</p>
</div>
</div>
<div class="section" id="stage-2">
<h3>Stage 2<a class="headerlink" href="#stage-2" title="Permalink to this headline">¶</a></h3>
<p>这个阶段的GRUB能够提供文件系统的查询以及一些交互等功能。任务是加载 Linux 内核和可选的初始 RAM 磁盘。</p>
<p>下面是/boot/grub/grub.cfg里某个菜单选项的片段。也可以直接在grub的shell里输入执行。</p>
<div class="highlight-python"><pre>set root='(hd0,msdos8)'
search --no-floppy --fs-uuid --set=root 577f602b-deab-440b-8bd9-9995ccff351d
linux   /boot/vmlinuz-3.2.0-23-generic root=UUID=577f602b-deab-440b-8bd9-9995ccff351d ro   quiet splash acpi=off  $vt_handoff
initrd  /boot/initrd.img-3.2.0-23-generic</pre>
</div>
<p>根据 <a class="reference external" href="http://www.gnu.org/software/grub/manual/grub.html">GRUB官方手册</a> 的说明，这四句的大意是</p>
<ol class="arabic simple">
<li>设置环境变量root。如果在其他表示路径却没有显式的标识设备的地方，都会把这个当作默认。</li>
<li>查找指定的设备(by uuid)。如果存在就设置到指定的环境变量里。 （第一、二句算个双保险吧）</li>
<li>装载一个内核映像。**vmlinuz-3.2.0-23-generic** 之后的都是内核参数。root是指定根文件系统。其他参数见: <a class="reference external" href="http://www.kernel.org/doc/Documentation/kernel-parameters.txt">Kernel Paramters</a></li>
<li>装载一个initrd。</li>
</ol>
<p>会这四句，可保万世....</p>
</div>
</div>
<div class="section" id="id1">
<h2>内核启动<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>GRUB2 加载两个东西。一个是vmlinuz，一个是initrd。</p>
<p>它们都是什么？ 起什么作用？</p>
<div class="section" id="vmlinuz">
<h3>vmlinuz是什么<a class="headerlink" href="#vmlinuz" title="Permalink to this headline">¶</a></h3>
<p>vmlinuz就是linux的kernel。</p>
<div class="highlight-python"><pre>它负责管理系统的进程、内存、设备驱动程序、文件和网络系统。</pre>
</div>
<img alt="../b_images/kernel.jpg" src="../b_images/kernel.jpg" />
<img alt="../b_images/linux_arch.jpg" src="../b_images/linux_arch.jpg" />
<p>如果自己编译一个内核就比较直观，可以自己选择需要的功能。并设定是 <strong>内核模块</strong> 还是 <strong>内置编译</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">make</span> <span class="n">menuconfig</span>
</pre></div>
</div>
<img alt="../b_images/menuconfig.png" src="../b_images/menuconfig.png" />
</div>
<div class="section" id="initrd">
<h3>initrd是什么<a class="headerlink" href="#initrd" title="Permalink to this headline">¶</a></h3>
<p>这东西主要发行版本为了兼容。</p>
<p>安装发行版本的时候，它可能面对各种各样的硬件。</p>
<p>linux内核可以模块化的，所以它不是很大。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">sudo</span> <span class="n">du</span> <span class="o">-</span><span class="n">sh</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">23</span><span class="o">-</span><span class="n">generic</span>
<span class="go">4.7M    /boot/vmlinuz-3.2.0-23-generic</span>
</pre></div>
</div>
<p>另外资料里说</p>
<blockquote>
<div><div class="highlight-python"><pre>initrd是一个小型的文件系统。内部包含启动所需的命令和内核模块。</pre>
</div>
</div></blockquote>
<p>那initrd具体是什么？ 还可以解压出来，直接看看...</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cp</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="n">generic</span>  <span class="o">.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">file</span> <span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="n">generic</span>
<span class="go">initrd.img-3.0.0-12-generic: gzip compressed data, from Unix, last modified: Wed Apr  4 22:03:00 2012</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">7</span><span class="n">z</span> <span class="n">x</span> <span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="n">generic</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">file</span> <span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">3.0</span>
<span class="go">initrd.img-3.0: ASCII cpio archive (SVR4 with no CRC)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cpio</span> <span class="o">-</span><span class="n">ivmd</span> <span class="o">&lt;</span> <span class="n">initrd</span><span class="o">.</span><span class="n">img</span><span class="o">-</span><span class="mf">3.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ls</span> <span class="o">-</span><span class="n">F</span>
<span class="go">bin/   etc/   initrd.img-3.0               lib/  sbin/</span>
<span class="go">conf/  init*  initrd.img-3.0.0-12-generic  run/  scripts/</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>启动控制<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>所有程序的父进程，可通 <strong>pstree</strong> 直观的查看。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">pstree</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span>
<span class="go">init-+-/usr/bin/termin-+-/usr/bin/termin</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>登录管理<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Ubuntu最新的几个版本所用的登录管理程序都是LightDM。其他linux的发行版也有用KDM的。</p>
<p>可以选择不同的登录用户和桌面系统。</p>
</div>
<div class="section" id="id4">
<h2>交互环境<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>用户登录后会执行一系列的脚本，初始化。</p>
<ol class="arabic simple">
<li>/etc/profile</li>
<li>/etc/bash.bashrc</li>
<li>~/.bash_profile</li>
<li>~/.bashrc</li>
<li>~/.bash_aliases</li>
</ol>
<p>Ubuntu的话，还有一个 <strong>~/.config/autostart</strong> 目录会自动执行里面的desktop文件。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">理解Linux启动</a><ul>
<li><a class="reference internal" href="#bios">系统启动（BIOS）</a></li>
<li><a class="reference internal" href="#bootloader">引导程序 （Bootloader）</a><ul>
<li><a class="reference internal" href="#stage-1">Stage 1</a></li>
<li><a class="reference internal" href="#stage-2">Stage 2</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">内核启动</a><ul>
<li><a class="reference internal" href="#vmlinuz">vmlinuz是什么</a></li>
<li><a class="reference internal" href="#initrd">initrd是什么</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2">启动控制</a></li>
<li><a class="reference internal" href="#id3">登录管理</a></li>
<li><a class="reference internal" href="#id4">交互环境</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../b_sources/ubuntu/startup.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../index.html">Ubuntu GNU/linux 笔记 v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, riptide711.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>